-- Description:
-- L1Menu logic generated by VHDL Producer:

-- Module ID: 0

-- Name of L1 Trigger Menu:
-- L1Menu_test_compare_gtl_struct_v4

-- Unique ID of L1 Trigger Menu:
-- fe5957aa-1a58-4062-bc19-4a4fa1c3e7f6

-- Unique ID of firmware implementation:
-- 8c8c211e-28df-4365-b661-661bb5585c2c

-- Scale set:
-- scales_2018_08_07

-- VHDL producer version
-- v2.6.1

-- ========================================================

library ieee;
use ieee.std_logic_1164.all;

use work.lhc_data_pkg.all;
use work.gtl_pkg.all;
use work.l1menu_pkg.all;

entity l1menu is
    port(
        lhc_clk : in std_logic;
        data : in data_pipeline_record;
        conv : in conv_pipeline_record;
        algo : out std_logic_vector(NR_ALGOS-1 downto 0));
end l1menu;

architecture rtl of l1menu is

-- Calculations outputs
    -- Differences
    signal sub_eta_jet_jet : obj_bx_max_eta_range_array;
    signal sub_phi_jet_jet : obj_bx_max_phi_range_array;
    signal sub_eta_jet_tau : obj_bx_max_eta_range_array;
    signal sub_phi_jet_tau : obj_bx_max_phi_range_array;
    -- Correlation cuts
    signal tbpt_jet_tau : obj_bx_corr_cuts_std_logic_array;
    signal tbpt_jet_jet : obj_bx_corr_cuts_std_logic_array;
    signal deta_jet_jet : obj_bx_corr_cuts_std_logic_array;
    signal deta_jet_tau : obj_bx_corr_cuts_std_logic_array;
    signal dphi_jet_tau : obj_bx_corr_cuts_std_logic_array;
    signal dphi_jet_tau : obj_bx_corr_cuts_std_logic_array;
    signal dr_jet_tau : obj_bx_corr_cuts_std_logic_array;
    signal cosh_deta_jet_tau : obj_bx_corr_cuts_std_logic_array;
    signal cos_dphi_jet_tau : obj_bx_corr_cuts_std_logic_array;

-- Comparators outputs
    -- Object cuts    
    signal pt_jet_1 : jet_obj_t;
    signal pt_tau_1 : tau_obj_t;
    signal iso_tau_1 : tau_obj_t;
    -- Correlation cuts    
    signal deta_jet_jet_1 : jet_jet_t;
    signal deta_jet_tau_1 : jet_tau_t;
    signal dr_jet_tau_1 : jet_tau_t;
    signal inv_mass_jet_tau_1 : jet_tau_t;
    signal tbpt_jet_jet_1 : jet_jet_t;
    signal tbpt_jet_tau_1 : jet_tau_t;

-- Conditions inputs
    -- Object cuts "and"  
    signal comb_jet_1 : jet_obj_t;
    signal comb_tau_1 : tau_obj_t;
    signal comb_tau_2 : tau_obj_t;

-- Signal definition for conditions names
    signal double_jet_i0 : std_logic;
    signal invariant_mass_ov_rm_i1 : std_logic;
    signal calo_calo_correlation_ov_rm_i2 : std_logic;
    signal calo_calo_correlation_i3 : std_logic;

-- Signal definition for algorithms names
    signal l1_test_double_jet30_tbpt60 : std_logic;
    signal l1_test_jet35_iso_tau45_mass_min450_rm_ovlp : std_logic;
    signal l1_test_double_jet30_tau45_deta_ignore_tbpt60_orm_dr0p2 : std_logic;
    signal l1_test_jet30_tau45_deta_ignore_tbpt60 : std_logic;
    
begin

-- First stage: calculations

    calc_1_i: entity work.twobody_pt
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS,
            JET_PT_VECTOR_WIDTH, TAU_PT_VECTOR_WIDTH,
            JET_TAU_SIN_COS_VECTOR_WIDTH
        )
        port map(
            conv.jet(bx(0)).pt_vector,
            conv.tau(bx(0)).pt_vector,
            conv.jet(bx(0)).cos_phi,
            conv.tau(bx(0)).cos_phi,
            conv.jet(bx(0)).sin_phi,
            conv.tau(bx(0)).sin_phi,
            tbpt_jet_tau(bx(0),bx(0))
        );

    calc_1a_i: entity work.twobody_pt
        generic map(
            N_JET_OBJECTS, N_JET_OBJECTS,
            JET_PT_VECTOR_WIDTH, JET_PT_VECTOR_WIDTH,
            JET_JET_SIN_COS_VECTOR_WIDTH
        )
        port map(
            conv.jet(bx(0)).pt_vector,
            conv.jet(bx(0)).pt_vector,
            conv.jet(bx(0)).cos_phi,
            conv.jet(bx(0)).cos_phi,
            conv.jet(bx(0)).sin_phi,
            conv.jet(bx(0)).sin_phi,
            tbpt_jet_jet(bx(0),bx(0))
        );

    calc_2_i: entity work.sub_eta
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
        )
        port map(
            conv.jet(bx(0)).eta,
            conv.tau(bx(0)).eta,
            sub_eta_jet_tau(bx(0),bx(0))
        );

    calc_3_i: entity work.diff_eta_lut
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
        )
        port map(
            sub_eta_jet_tau(bx(0),bx(0)),
            deta_jet_tau(bx(0),bx(0))
        );

    calc_4_i: entity work.sub_phi
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
            JET_TAU_PHI_HALF_RANGE_BINS
        )
        port map(
            conv.jet(bx(0)).phi,
            conv.tau(bx(0)).phi,
            sub_phi_jet_tau(bx(0),bx(0))
        );

    calc_5_i: entity work.diff_phi_lut
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
        )
        port map(
            sub_phi_jet_tau(bx(0),bx(0)),
            dphi_jet_tau(bx(0),bx(0))
        );

    calc_6_i: entity work.delta_r
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
        )
        port map(
            deta_jet_tau(bx(0),bx(0)),
            dphi_jet_tau(bx(0),bx(0)),
            dr_jet_tau(bx(0),bx(0))
        );
        
    calc_7_i: entity work.sub_eta
        generic map(
            N_JET_OBJECTS, N_JET_OBJECTS, (jet_t,jet_t)
        )
        port map(
            conv.jet(bx(0)).eta,
            conv.jet(bx(0)).eta,
            sub_eta_jet_jet(bx(0),bx(0))
        );

    calc_8_i: entity work.diff_eta_lut
        generic map(
            N_JET_OBJECTS, N_JET_OBJECTS, (jet_t,jet_t)
        )
        port map(
            sub_eta_jet_jet(bx(0),bx(0)),
            deta_jet_jet(bx(0),bx(0))
        );

    calc_9_i: entity work.cosh_deta_lut
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
        )
        port map(
            sub_eta_jet_tau(bx(0),bx(0)),
            cosh_deta_jet_tau(bx(0),bx(0))
        );

    calc_10_i: entity work.cos_dphi_lut
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t)
        )
        port map(
            sub_phi_jet_tau(bx(0),bx(0)),
            cos_dphi_jet_tau(bx(0),bx(0))
        );

    calc_11_i: entity work.invariant_mass
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t),
            JET_PT_VECTOR_WIDTH, TAU_PT_VECTOR_WIDTH,
            JET_TAU_COSH_COS_VECTOR_WIDTH
        )
        port map(
            conv.jet(bx(0)).pt_vector,
            conv.tau(bx(0)).pt_vector,
            cosh_deta_jet_tau(bx(0),bx(0)),
            cos_dphi_jet_tau(bx(0),bx(0)),
            inv_mass_jet_tau(bx(0),bx(0))
        );
        
-- Second stage: comparisons

    comp_1_i: entity work.comparators_obj_cuts
        generic map(
            N_JET_OBJECTS, JET_PT_WIDTH,
            GE, X"003C", X"0000", X"0000"
        )
        port map(
            lhc_clk, data.jet(bx(0)).pt, pt_jet_1
        );

    comp_2_i: entity work.comparators_obj_cuts
        generic map(
            N_TAU_OBJECTS, TAU_PT_WIDTH,
            GE, X"005A", X"0000", X"0000"
        )
        port map(
            lhc_clk, data.tau(bx(0)).pt, pt_tau_1
        );

    comp_3_i: entity work.comparators_obj_cuts
        generic map(
            N_TAU_OBJECTS, TAU_ISO_WIDTH,
            ISO, X"0000", X"0000", X"000E"
        )
        port map(
            lhc_clk, data.tau(bx(0)).iso, iso_tau_1
        );

    comp_4_i: entity work.comparators_corr_cuts
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t),
            JET_TAU_DELTAETA_VECTOR_WIDTH, deltaEta,
            X"0000000000000", X"0000000002710"
        )
        port map(
            lhc_clk, deta_jet_tau(bx(0),bx(0)), deta_jet_tau_1
        );

    comp_5_i: entity work.comparators_corr_cuts
        generic map(
            N_JET_OBJECTS, N_JET_OBJECTS, (jet_t,jet_t),
            JET_JET_DELTAETA_VECTOR_WIDTH, deltaEta,
            X"0000000000000", X"0000000002710"
        )
        port map(
            lhc_clk, deta_jet_jet(bx(0),bx(0)), deta_jet_jet_1
        );

    comp_6_i: entity work.comparators_corr_cuts
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t),
            EG_JET_DELTAR_VECTOR_WIDTH, deltaR,
            X"0000000000000", X"000000000A028"
        )
        port map(
            lhc_clk, dr_jet_tau(bx(0),bx(0)), dr_jet_tau_1
        );

    comp_7_i: entity work.comparators_corr_cuts
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t),
            JET_TAU_MASS_VECTOR_WIDTH, mass,
            X"000025B7F3D40", X"41A6642C78140"
        )
        port map(
            lhc_clk, inv_mass_jet_tau(bx(0),bx(0)), inv_mass_jet_tau_1
        );

    comp_8_i: entity work.comparators_corr_cuts
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS, (jet_t,tau_t),
            JET_TAU_TBPT_VECTOR_WIDTH, twoBodyPt,
            X"00053D1AC1000", X"0000000000000"
        )
        port map(
            lhc_clk, tbpt_jet_tau(bx(0),bx(0)), tbpt_jet_tau_1
        );

    comp_9_i: entity work.comparators_corr_cuts
        generic map(
            N_JET_OBJECTS, N_JET_OBJECTS, (jet_t,jet_t),
            JET_JET_TBPT_VECTOR_WIDTH, twoBodyPt,
            X"00053D1AC1000", X"0000000000000"
        )
        port map(
            lhc_clk, tbpt_jet_jet(bx(0),bx(0)), tbpt_jet_jet_1
        );

-- Third stage: conditions and algos
    
    -- Creating condition inputs (combination of object cuts)
    
    comb_jet_1 <= pt_jet_1;
    comb_tau_1 <= pt_tau_1;
    comb_tau_2 <= pt_tau_1 and iso_tau_1;
        
    -- Instantiations of conditions
    
    double_jet_i0_i: entity work.combinatorial_conditions
        generic map(
            N_JET_OBJECTS, 2,
            ((0,11),(0,11),(0,0),(0,0)),
            false
        )
        port map(
            lhc_clk, 
            comb_1 => comb_jet_1,
            comb_2 => comb_jet_1,
            tbpt => tbpt_jet_jet_1,
            cond_o => double_jet_i0
        );

    calo_calo_correlation_i3_i: entity work.correlation_conditions
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS,
            ((0,11),(0,11),(0,0),(0,0)),
            false
        )
        port map(
            lhc_clk, comb_jet_1, comb_tau_1,
            deta => deta_jet_tau_1,
            tbpt => tbpt_jet_tau_1
            cond_o => calo_calo_correlation_i3
        );

    calo_calo_correlation_ov_rm_i2_i: entity work.correlation_conditions_ovrm
        generic map(
            N_JET_OBJECTS, N_JET_OBJECTS, N_TAU_OBJECTS,
            ((0,11),(0,11),(0,11),(0,0)),
            false, true
        )
        port map(
            lhc_clk, comb_jet_1, comb_jet_1, comb_tau_1,
            deta => deta_jet_jet_1,
            tbpt => tbpt_jet_jet_1
            dr_ovrm => dr_jet_tau_1,
            cond_o => calo_calo_correlation_ov_rm_i2
        );

    invariant_mass_ov_rm_i1_i: entity work.correlation_conditions_ovrm
        generic map(
            N_JET_OBJECTS, N_TAU_OBJECTS,
            ((0,11),(0,11),(0,0),(0,0)),
            false, false
        )
        port map(
            lhc_clk, comb_jet_1, comb_tau_2,
            inv_mass => inv_mass_jet_tau_1,
            tbpt => tbpt_jet_tau_1
            dr_ovrm => dr_jet_tau_1,
            cond_o => invariant_mass_ov_rm_i1
        );

-- Instantiations of algorithms

-- 0 L1_Test_DoubleJet30_Tbpt60 : comb{JET30,JET30}[TBPT_1]
l1_test_double_jet30_tbpt60 <= double_jet_i0;
algo(0) <= l1_test_double_jet30_tbpt60;

-- 1 L1_Test_Jet35_IsoTau45_Mass_Min450_RmOvlp : mass_inv_orm{JET35,TAU45[TAU-ISO_0xE]}[MASS_MIN_450,ORMDR_0p2]
l1_test_jet35_iso_tau45_mass_min450_rm_ovlp <= invariant_mass_ov_rm_i1;
algo(3) <= l1_test_jet35_iso_tau45_mass_min450_rm_ovlp;

-- 2 L1_Test_DoubleJet30_Tau45_Deta_ignore_Tbpt60_OrmDr0p2 : dist_orm{JET30,JET30,TAU45}[DETA_ignore,ORMDR_0p2,TBPT_1]
l1_test_double_jet30_tau45_deta_ignore_tbpt60_orm_dr0p2 <= calo_calo_correlation_ov_rm_i2;
algo(2) <= l1_test_double_jet30_tau45_deta_ignore_tbpt60_orm_dr0p2;

-- 3 L1_Test_Jet30_Tau45_Deta_ignore_Tbpt60 : dist{JET30,TAU45}[DETA_ignore,TBPT_1]
l1_test_jet30_tau45_deta_ignore_tbpt60 <= calo_calo_correlation_i3;
algo(1) <= l1_test_jet30_tau45_deta_ignore_tbpt60;

end architecture rtl;

